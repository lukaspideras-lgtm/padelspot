<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Potvrđujemo nalog – Padel Spot</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f5f5f5; }
    .msg { color: #333; margin: 1rem 0; }
    .err { color: #c00; }
    .btn { display: inline-block; margin-top: 1.5rem; padding: 14px 28px; background: #8dbc3f; color: #fff; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; }
    .btn:hover { background: #7aab30; }
  </style>
</head>
<body>
  <p class="msg">Potvrđujemo nalog...</p>
  <p class="msg">Otvori aplikaciju Padel Spot.</p>
  <div id="manual" style="display:none;">
    <p class="msg">Aplikacija se nije otvorila automatski?</p>
    <a id="openBtn" href="#" class="btn">Otvori Padel Spot</a>
  </div>
  <script>
    (function() {
      var SUPABASE_URL = 'https://gauqwehxhgkukjvvpths.supabase.co';
      var SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhdXF3ZWh4aGdrdWtqdnZwdGhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NTI1NzcsImV4cCI6MjA4NjIyODU3N30._ze6tu7EC0YIwGa3bHk8FhLNWmfAsAY-FWt0KmmMRLk';
      var hash = window.location.hash.slice(1);
      if (!hash) {
        document.body.innerHTML = '<p class="msg">Neispravan link. Zatražite novi email (Pošalji ponovo).</p>';
        return;
      }
      var params = {};
      hash.split('&').forEach(function(p) {
        var kv = p.split('=');
        if (kv[0] && kv[1]) params[decodeURIComponent(kv[0])] = decodeURIComponent(kv[1]);
      });
      var access = params.access_token, refresh = params.refresh_token;

      function show(msg, isErr) {
        document.body.innerHTML = '<p class="msg' + (isErr ? ' err' : '') + '">' + msg + '</p>';
      }

      function getEmailFromToken(token) {
        try {
          var parts = token.split('.');
          if (parts.length !== 3) return null;
          var b64 = parts[1].replace(/-/g,'+').replace(/_/g,'/');
          var pad = b64.length % 4;
          if (pad) b64 += new Array(5 - pad).join('=');
          var json = atob(b64);
          var data = JSON.parse(json);
          return (data && (data.email || data['email'])) || null;
        } catch(e) { return null; }
      }

      if (params.error) {
        show('Link je istekao. Zatražite novi (Pošalji ponovo).', true);
        return;
      }

      if (!access || !refresh) {
        show('Neispravan link. Zatražite novi email.', true);
        return;
      }

      if (!SUPABASE_URL || !SUPABASE_ANON || SUPABASE_URL.indexOf('http') !== 0) {
        show('Server nije pravilno podešen. Kontaktirajte podršku.', true);
        return;
      }

      var email = getEmailFromToken(access);
      if (!email) {
        show('Nije moguće pročitati email. Zatražite novi link (Pošalji ponovo).', true);
        return;
      }

      fetch(SUPABASE_URL + '/rest/v1/rpc/store_pending_session', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON,
          'Authorization': 'Bearer ' + SUPABASE_ANON
        },
        body: JSON.stringify({ p_email: email, p_access_token: access, p_refresh_token: refresh })
      })
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(function() {
        document.body.innerHTML = '<p class="msg">Nalog je potvrđen!</p><p class="msg">Vratite se u aplikaciju Padel Spot – ona će vas automatski ulogovati u roku par sekundi.</p>';
      })
      .catch(function() {
        show('Greška pri čuvanju. Zatražite novi link (Pošalji ponovo).', true);
      });
    })();
  </script>
</body>
</html>
